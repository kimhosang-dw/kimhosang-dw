<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>협업용 일정 관리 툴</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        
        .user-btn-wrapper { position: relative; }
        .user-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .plan-cell { min-height: 120px; cursor: pointer; } 
        .plan-item { cursor: pointer; }
        .scrollable-table { min-width: 800px; }
        
        .horizontal-scroll-wrapper { position: relative; }
        .horizontal-scroll-wrapper::after {
            content: '⇿'; font-size: 20px; color: #9ca3af; position: absolute; top: 50%; right: 0px;
            transform: translateY(-50%); background: linear-gradient(to left, white, rgba(255,255,255,0.8) 50%, transparent);
            padding: 20px 5px 20px 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .is-scrollable::after { opacity: 1; }
        .filter-btn.active { background-color: #0d9488; color: white; }
        .sticky-col { position: -webkit-sticky; position: sticky; left: 0; z-index: 10; }
        .goal-input:checked + span { text-decoration: line-through; color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
    
    <!-- 실제 앱 컨테이너 -->
    <div id="app-container">
        <!-- 사용자 관리 및 선택 화면 -->
        <div id="user-management-view" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-sm sm:max-w-lg">
                <h1 class="text-2xl sm:text-3xl font-bold mb-2 text-center">사용자 관리</h1>
                <p class="text-gray-600 mb-6 text-center text-sm sm:text-base">사용자를 추가하거나, 목록에서 선택하여 시작하세요.</p>
                
                <div class="flex gap-2 sm:gap-4 mb-6">
                    <input type="text" id="new-user-name" placeholder="새 사용자 이름" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <button id="add-user-btn" class="bg-teal-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-teal-700 transition whitespace-nowrap">추가</button>
                </div>

                <h2 class="text-lg font-semibold mb-3">사용자 목록</h2>
                <div id="user-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-60 overflow-y-auto pr-2 border-t pt-3">
                    <!-- 사용자가 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>

        <!-- 메인 앱 화면 (초기에는 숨김) -->
        <div id="main-app-view" class="container mx-auto p-3 sm:p-4 md:p-6 max-w-7xl hidden">
            <header class="mb-6 sm:mb-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">협업 일정 관리</h1>
                    <p id="user-info" class="text-base sm:text-md text-gray-600 mt-1"></p>
                </div>
                <button id="change-user-btn" class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-5 rounded-lg transition"><i class="fas fa-user-edit mr-2"></i>사용자 변경</button>
            </header>

            <!-- 주간 작업계획표 -->
            <section id="weekly-plan-view" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-8">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-2">
                    <h2 class="text-xl sm:text-2xl font-bold">주간 작업계획표</h2>
                    <div class="flex items-center gap-2 self-end sm:self-center">
                        <button id="prev-week-btn" class="p-3 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="week-display" class="text-base sm:text-lg font-semibold whitespace-nowrap"></h3>
                        <button id="next-week-btn" class="p-3 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="table-scroll-wrapper" class="horizontal-scroll-wrapper">
                    <div id="table-overflow-container" class="overflow-x-auto">
                        <table class="w-full border-collapse text-center scrollable-table">
                            <thead id="weekly-plan-head"></thead>
                            <tbody id="weekly-plan-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 하단 일정 관리 -->
            <section id="daily-tasks-view">
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">새 일정 추가</h3>
                    <form id="add-task-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="task-content" class="block text-sm font-medium text-gray-700 mb-1">작업 내용</label>
                            <input type="text" id="task-content" placeholder="예: PET 분류 작업" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500" required>
                        </div>
                        <div>
                            <label for="task-category" class="block text-sm font-medium text-gray-700 mb-1">구분</label>
                            <select id="task-category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                                <option value="입고">입고</option>
                                <option value="출고">출고</option>
                                <option value="개발">개발</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        
                        <div id="single-date-container">
                            <label for="task-due-date" class="block text-sm font-medium text-gray-700 mb-1">마감일</label>
                            <input type="date" id="task-due-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                        </div>
                        
                        <div id="date-range-container" class="hidden grid grid-cols-2 gap-4 md:col-span-1">
                             <div>
                                <label for="task-start-date" class="block text-sm font-medium text-gray-700 mb-1">시작일</label>
                                <input type="date" id="task-start-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            </div>
                             <div>
                                <label for="task-end-date" class="block text-sm font-medium text-gray-700 mb-1">종료일</label>
                                <input type="date" id="task-end-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition flex items-center justify-center"><i class="fas fa-plus mr-2"></i>추가하기</button>
                    </form>
                </div>
                
                <div class="mb-4 flex items-center justify-start space-x-2 bg-white p-3 rounded-lg shadow-sm">
                    <span class="font-semibold mr-2">필터:</span>
                    <button data-filter="all" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition bg-gray-200 active">전체</button>
                    <button data-filter="입고" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition bg-gray-200">입고</button>
                    <button data-filter="출고" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition bg-gray-200">출고</option>
                    <button data-filter="개발" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition bg-gray-200">개발</button>
                    <button data-filter="기타" class="filter-btn px-4 py-2 rounded-lg text-sm font-semibold transition bg-gray-200">기타</button>
                </div>

                <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <!-- 일정 목록이 여기에 표시됩니다. -->
                </main>
            </section>

            <!-- 목표 관리 -->
            <section id="goals-view" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">주간 목표</h3>
                    <div id="weekly-goals-list" class="space-y-2">
                        <!-- 주간 목표 아이템 -->
                    </div>
                    <button id="add-weekly-goal-btn" class="mt-4 w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-plus mr-2"></i> 목표 추가
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">월간 목표</h3>
                    <div id="monthly-goals-list" class="space-y-2">
                        <!-- 월간 목표 아이템 -->
                    </div>
                    <button id="add-monthly-goal-btn" class="mt-4 w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-plus mr-2"></i> 목표 추가
                    </button>
                </div>
            </section>
        </div>

        <!-- 모달 컨테이너 -->
        <div id="modal-container"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, getDoc, setDoc, arrayUnion, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyB2Gf8Rgal2lL-eHXpxEVSkObJrAwlnLXk",
                authDomain: "dowon-scheduler.firebaseapp.com",
                projectId: "dowon-scheduler",
                storageBucket: "dowon-scheduler.appspot.com",
                messagingSenderId: "729645736346",
                appId: "1:729645736346:web:dd77701301343dce131a23"
            };
            
            const appId = 'default-schedule-app';
            const MACHINES = ["1호기", "2호기", "3호기", "배합", "리본배합"];
            const USER_COLORS = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c', '#34495e'];

            let app, db, auth, firebaseUserId;
            let usersCollectionRef, tasksCollectionRef, workPlanCollectionRef, goalsDocRef;
            let currentUser = null;
            let allUsers = [];
            let allTasks = [];
            let currentCategoryFilter = 'all';
            let currentDayOffset = 0;
            let unsubscribeTasks = () => {}, unsubscribeUsers = () => {}, unsubscribeWorkPlan = () => {}, unsubscribeGoals = () => {};
            let holidayCache = {};

            const appContainer = document.getElementById('app-container');
            const userManagementView = document.getElementById('user-management-view');
            const mainAppView = document.getElementById('main-app-view');
            const userList = document.getElementById('user-list');
            const addUserBtn = document.getElementById('add-user-btn');
            const newUserInput = document.getElementById('new-user-name');
            const changeUserBtn = document.getElementById('change-user-btn');
            const userInfo = document.getElementById('user-info');
            const weekDisplay = document.getElementById('week-display');
            const weeklyPlanHead = document.getElementById('weekly-plan-head');
            const weeklyPlanBody = document.getElementById('weekly-plan-body');
            const addTaskForm = document.getElementById('add-task-form');
            const taskList = document.getElementById('task-list');
            const tableScrollWrapper = document.getElementById('table-scroll-wrapper');
            const tableOverflowContainer = document.getElementById('table-overflow-container');
            const modalContainer = document.getElementById('modal-container');

            // --- 날짜 유틸리티 함수 (시간대 문제 해결) ---
            function toYYYYMMDD(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function parseYYYYMMDD(dateString) {
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            }

            function get7DaysInfo(offset = 0) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                today.setDate(today.getDate() + offset);
                
                const dates = Array.from({length: 7}, (_, i) => {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    return d;
                });
                
                const year = today.getFullYear();
                const startOfYear = new Date(year, 0, 1);
                const weekNumber = Math.ceil(((today - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
                
                return {
                    id: `${year}-W${String(weekNumber).padStart(2, '0')}`,
                    start: dates[0],
                    end: dates[6],
                    dates: dates
                };
            }
            
            async function fetchHolidaysForDates(dates) {
                const years = [...new Set(dates.map(d => d.getFullYear()))];
                for (const year of years) {
                    if (!holidayCache[year]) {
                        await fetchHolidays(year);
                    }
                }
            }

            async function fetchHolidays(year) {
                const serviceKey = "YOUR_PUBLIC_DATA_API_KEY"; // 여기에 실제 키를 입력하세요.
                if (serviceKey === "YOUR_PUBLIC_DATA_API_KEY") {
                    console.warn("공공데이터포털 API 키가 설정되지 않았습니다. 공휴일 정보가 표시되지 않습니다.");
                    holidayCache[year] = {};
                    return;
                }
                const url = `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?solYear=${year}&ServiceKey=${serviceKey}&_type=json&numOfRows=100`;
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    const items = data.response.body.items.item;
                    const holidays = {};
                    if (items) {
                        (Array.isArray(items) ? items : [items]).forEach(item => {
                            const dateStr = String(item.locdate);
                            const formattedDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                            holidays[formattedDate] = item.dateName;
                        });
                    }
                    holidayCache[year] = holidays;
                } catch (e) {
                    console.error("공휴일 정보 로딩 실패:", e);
                    holidayCache[year] = {};
                }
            }

            function escapeHTML(str) { return str ? str.replace(/[&<>'"]/g, tag => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[tag]||tag)) : ''; }

            // --- 앱 로직 ---
            async function initializeFirebase() {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    usersCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
                    tasksCollectionRef = collection(db, `artifacts/${appId}/public/data/schedules`);
                    workPlanCollectionRef = collection(db, `artifacts/${appId}/public/data/workPlan`);
                    goalsDocRef = doc(db, `artifacts/${appId}/public/data/goals`, 'current');

                    onAuthStateChanged(auth, user => {
                        if (user) {
                            firebaseUserId = user.uid;
                            showUserManagementScreen();
                        } else {
                            signInAnonymously(auth).catch(err => console.error("익명 로그인 실패:", err));
                        }
                    });
                } catch (error) {
                    console.error("Firebase 초기화 실패:", error);
                }
            }

            function showUserManagementScreen() {
                unsubscribeAll();
                userManagementView.classList.remove('hidden');
                mainAppView.classList.add('hidden');
                
                addUserBtn.onclick = addNewUser;
                newUserInput.onkeydown = (e) => { if (e.key === 'Enter') addNewUser(); };

                unsubscribeUsers = onSnapshot(usersCollectionRef, snapshot => {
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUserList(allUsers);
                });
            }

            function showMainAppScreen(user) {
                unsubscribeAll();
                if (user) currentUser = user; // 사용자 변경이 아닐 경우 기존 사용자 유지
                userManagementView.classList.add('hidden');
                mainAppView.classList.remove('hidden');
                
                attachMainAppEventListeners();
                
                userInfo.innerHTML = `<span class="font-bold" style="color:${currentUser.color};">${currentUser.name}</span>님, 환영합니다.`;
                
                listenForGoals();
                renderWeeklyPlan();
                listenForTasks();
                listenForUsersForColorMapping();
            }

            function attachMainAppEventListeners() {
                changeUserBtn.onclick = showUserManagementScreen;
                addTaskForm.onsubmit = handleAddTask;
                document.getElementById('prev-week-btn').onclick = () => { currentDayOffset -= 7; renderWeeklyPlan(); };
                document.getElementById('next-week-btn').onclick = () => { currentDayOffset += 7; renderWeeklyPlan(); };
                window.addEventListener('resize', checkTableScroll);
                setupCategoryFilters();
                document.getElementById('task-category').onchange = toggleDateFields;
                document.getElementById('add-weekly-goal-btn').onclick = () => addGoal('weekly');
                document.getElementById('add-monthly-goal-btn').onclick = () => addGoal('monthly');
            }

            function unsubscribeAll() {
                unsubscribeTasks();
                unsubscribeUsers();
                unsubscribeWorkPlan();
                unsubscribeGoals();
            }
            
            async function addNewUser() {
                const name = newUserInput.value.trim();
                if (!name) return;
                
                try {
                    const snapshot = await getDocs(usersCollectionRef);
                    const colorIndex = snapshot.size % USER_COLORS.length;
                    const color = USER_COLORS[colorIndex];
                    
                    await addDoc(usersCollectionRef, { name, color });
                    newUserInput.value = '';
                } catch (error) {
                    console.error("사용자 추가 오류:", error);
                }
            }

            function renderUserList(users) {
                if (!userList) return;
                userList.innerHTML = '';
                users.forEach(user => {
                    const btnWrapper = document.createElement('div');
                    btnWrapper.className = 'user-btn-wrapper';

                    const renderNormalState = () => {
                        btnWrapper.innerHTML = '';
                        const btn = document.createElement('button');
                        btn.className = 'user-btn w-full p-3 rounded-lg text-white font-bold shadow-md transition text-sm';
                        btn.textContent = user.name;
                        btn.style.backgroundColor = user.color;
                        btn.onclick = () => showMainAppScreen(user);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'absolute top-1 right-1 text-white text-opacity-60 hover:text-opacity-100 transition-opacity p-1';
                        deleteBtn.innerHTML = '<i class="fas fa-times-circle text-base"></i>';
                        deleteBtn.onclick = (e) => { e.stopPropagation(); openUserDeleteConfirmModal(user.id, user.name); };
                        
                        btnWrapper.appendChild(btn);
                        btnWrapper.appendChild(deleteBtn);
                    };
                    
                    renderNormalState();
                    userList.appendChild(btnWrapper);
                });
            }

            async function deleteUser(userId) {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userId);
                await deleteDoc(userDocRef);
                if (currentUser && currentUser.id === userId) {
                    showUserManagementScreen();
                }
            }

            async function renderWeeklyPlan() {
                const week = get7DaysInfo(currentDayOffset);
                await fetchHolidaysForDates(week.dates);

                weekDisplay.textContent = `${week.start.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })} ~ ${week.end.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}`;
                
                let headHTML = '<tr><th class="p-2 border bg-gray-200 text-sm sticky-col w-16">설비</th>';
                const dayNames = ["일", "월", "화", "수", "목", "금", "토"];
                week.dates.forEach((date) => {
                    const dayOfWeek = date.getDay();
                    const dateString = toYYYYMMDD(date);
                    const holiday = holidayCache[dateString];
                    
                    let textColor = '';
                    if (holiday) textColor = 'text-red-600';
                    else if (dayOfWeek === 0) textColor = 'text-red-600';
                    else if (dayOfWeek === 6) textColor = 'text-blue-600';

                    const isToday = toYYYYMMDD(new Date()) === dateString;
                    
                    headHTML += `<th class="px-1 py-1 border text-sm ${isToday ? 'bg-teal-100' : 'bg-gray-50'}">
                                    <span class="${textColor}">${date.getMonth() + 1}/${date.getDate()}</span>
                                    <span class="font-normal ${textColor}">(${dayNames[dayOfWeek]})</span>
                                    ${holiday ? `<div class="text-xs font-normal text-red-500">${holiday}</div>` : ''}
                                 </th>`;
                });
                headHTML += '</tr>';
                weeklyPlanHead.innerHTML = headHTML;
                
                let bodyHTML = '';
                MACHINES.forEach(machine => {
                    bodyHTML += `<tr><td class="p-2 border font-semibold bg-gray-50 text-sm sticky-col w-16">${machine}</td>`;
                    week.dates.forEach(date => {
                        const dateString = toYYYYMMDD(date);
                        bodyHTML += `<td id="plan-${machine}-${dateString}" class="plan-cell p-1 border align-top text-xs" data-machine="${machine}" data-date="${dateString}"></td>`;
                    });
                    bodyHTML += '</tr>';
                });
                weeklyPlanBody.innerHTML = bodyHTML;
                
                listenForWorkPlan(week.id);
                
                weeklyPlanBody.onclick = (e) => {
                    const cell = e.target.closest('.plan-cell');
                    if (cell) {
                        const machine = cell.dataset.machine;
                        const date = cell.dataset.date;
                        openWorkPlanModal(machine, date);
                    }
                };

                setTimeout(checkTableScroll, 100);
            }

            function checkTableScroll() {
                if (tableOverflowContainer && tableScrollWrapper) {
                    if (tableOverflowContainer.scrollWidth > tableOverflowContainer.clientWidth) {
                        tableScrollWrapper.classList.add('is-scrollable');
                    } else {
                        tableScrollWrapper.classList.remove('is-scrollable');
                    }
                }
            }

            function listenForWorkPlan(weekId) {
                unsubscribeWorkPlan();
                const docRef = doc(workPlanCollectionRef, weekId);
                unsubscribeWorkPlan = onSnapshot(docRef, (docSnap) => {
                    if (!document.getElementById('weekly-plan-body')) return;
                    const planData = docSnap.exists() ? docSnap.data() : {};
                    populateWorkPlan(planData);
                });
            }

            function populateWorkPlan(planData) {
                document.querySelectorAll('.plan-cell').forEach(cell => cell.innerHTML = '');

                MACHINES.forEach(machine => {
                    const items = planData[machine] || [];
                    items.forEach(item => {
                        const start = parseYYYYMMDD(item.startDate);
                        const end = parseYYYYMMDD(item.endDate);
                        
                        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                            const dateString = toYYYYMMDD(d);
                            const targetCell = document.getElementById(`plan-${machine}-${dateString}`);
                            if (targetCell) drawPlanItemInCell(targetCell, item);
                        }
                    });
                });
            }

            function drawPlanItemInCell(cell, item) {
                if (cell.querySelector(`[data-id="${item.id}"]`)) return;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-blue-200 text-blue-800 plan-item rounded px-1.5 py-0.5 mb-1 truncate text-xs font-semibold';
                itemDiv.textContent = item.name;
                itemDiv.dataset.id = item.id;
                cell.appendChild(itemDiv);
            }
            
            function listenForUsersForColorMapping() {
                unsubscribeUsers();
                unsubscribeUsers = onSnapshot(usersCollectionRef, snapshot => {
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTaskList();
                });
            }

            function listenForTasks() {
                unsubscribeTasks();
                const q = query(tasksCollectionRef);
                unsubscribeTasks = onSnapshot(q, (snapshot) => {
                    allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTaskList();
                });
            }

            function renderTaskList() {
                if (!taskList) return;
                taskList.innerHTML = '';
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const futureTasks = allTasks.filter(task => {
                    const dueDate = task.dueDate || task.endDate;
                    return parseYYYYMMDD(dueDate) >= today;
                });
                
                const filteredTasks = currentCategoryFilter === 'all' 
                    ? futureTasks 
                    : futureTasks.filter(task => task.category === currentCategoryFilter);

                filteredTasks.sort((a, b) => {
                    const dateA = new Date(a.dueDate || a.endDate);
                    const dateB = new Date(b.dueDate || b.endDate);
                    return dateA - dateB;
                });

                if (filteredTasks.length === 0) {
                    taskList.innerHTML = '<p class="text-gray-500 text-center col-span-full">표시할 일정이 없습니다.</p>';
                } else {
                    filteredTasks.forEach(task => taskList.appendChild(createTaskCard(task)));
                }
            }

            function setupCategoryFilters() {
                const filterButtons = document.querySelectorAll('.filter-btn');
                filterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        filterButtons.forEach(btn => btn.classList.remove('active', 'bg-teal-600', 'text-white'));
                        button.classList.add('active', 'bg-teal-600', 'text-white');
                        currentCategoryFilter = button.dataset.filter;
                        renderTaskList();
                    });
                });
            }

            function createTaskCard(task) {
                const card = document.createElement('div');
                const authorColor = allUsers.find(u => u.name === task.authorName)?.color || '#607d8b';
                card.className = 'bg-white p-4 rounded-lg shadow-md transition-all duration-300 hover:shadow-xl hover:-translate-y-1';
                card.style.borderLeft = `5px solid ${authorColor}`;

                let dateText = '';
                if (task.startDate) {
                    dateText = `기간: ${task.startDate.substring(5)} ~ ${task.endDate.substring(5)}`;
                } else {
                    dateText = `마감: ${task.dueDate.substring(5)}`;
                }
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-semibold text-white px-2 py-1 rounded" style="background-color:${authorColor};">${escapeHTML(task.category)}</span>
                        <div>
                            <button class="edit-btn text-blue-500 p-1"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn text-red-500 p-1"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <p class="text-base font-semibold break-words my-2">${escapeHTML(task.content)}</p>
                    <p class="text-sm text-gray-600">${dateText}</p>
                    <p class="text-xs text-gray-500 mt-3">작성자: ${escapeHTML(task.authorName)}</p>
                `;
                
                card.querySelector('.edit-btn').addEventListener('click', () => openEditTaskModal(task));
                card.querySelector('.delete-btn').addEventListener('click', () => openDeleteConfirmModal(task.id));

                return card;
            }

            function toggleDateFields() {
                const category = document.getElementById('task-category').value;
                const singleDateContainer = document.getElementById('single-date-container');
                const dateRangeContainer = document.getElementById('date-range-container');
                
                if (category === '개발' || category === '기타') {
                    singleDateContainer.classList.add('hidden');
                    dateRangeContainer.classList.remove('hidden');
                    dateRangeContainer.classList.add('md:col-span-2');
                    addTaskForm.classList.add('md:grid-cols-6');
                    addTaskForm.classList.remove('md:grid-cols-5');
                } else {
                    singleDateContainer.classList.remove('hidden');
                    dateRangeContainer.classList.add('hidden');
                    dateRangeContainer.classList.remove('md:col-span-2');
                    addTaskForm.classList.remove('md:grid-cols-6');
                    addTaskForm.classList.add('md:grid-cols-5');
                }
            }
            
            async function handleAddTask(e) {
                e.preventDefault();
                const content = document.getElementById('task-content').value.trim();
                const category = document.getElementById('task-category').value;
                
                let taskData = {
                    content,
                    category,
                    authorName: currentUser.name,
                    authorId: firebaseUserId,
                    createdAt: serverTimestamp()
                };

                if (category === '개발' || category === '기타') {
                    taskData.startDate = document.getElementById('task-start-date').value;
                    taskData.endDate = document.getElementById('task-end-date').value;
                    if (!taskData.startDate || !taskData.endDate) {
                        alert('시작일과 종료일을 모두 입력해주세요.');
                        return;
                    }
                } else {
                    taskData.dueDate = document.getElementById('task-due-date').value;
                    if (!taskData.dueDate) {
                        alert('마감일을 입력해주세요.');
                        return;
                    }
                }

                if (content && currentUser) {
                    await addDoc(tasksCollectionRef, taskData);
                    addTaskForm.reset();
                    toggleDateFields();
                }
            }

            function showModal(innerHTML) {
                modalContainer.innerHTML = innerHTML;
                const modal = modalContainer.querySelector('.modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) closeModal();
                    });
                }
            }
            
            function closeModal() {
                modalContainer.innerHTML = '';
            }

            async function openWorkPlanModal(machine, date) {
                const modalHTML = `
                    <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md">
                            <div id="plan-form-container" class="space-y-4 mb-6 pb-4 border-b">
                                <!-- 폼이 여기에 동적으로 렌더링됩니다 -->
                            </div>
                            <div id="work-plan-items-list"></div>
                            <button id="close-work-plan-modal" class="mt-4 w-full bg-gray-200 py-2 rounded-lg hover:bg-gray-300">닫기</button>
                        </div>
                    </div>`;
                showModal(modalHTML);

                const listContainer = document.getElementById('work-plan-items-list');
                document.getElementById('close-work-plan-modal').onclick = closeModal;

                const weekId = get7DaysInfo(currentDayOffset).id;
                const docRef = doc(workPlanCollectionRef, weekId);
                const docSnap = await getDoc(docRef);
                const planData = docSnap.exists() ? docSnap.data() : {};
                const items = planData[machine] || [];
                const itemsForThisDate = items.filter(item => {
                    const start = parseYYYYMMDD(item.startDate);
                    const end = parseYYYYMMDD(item.endDate);
                    const clickedDate = parseYYYYMMDD(date);
                    return clickedDate >= start && clickedDate <= end;
                });

                listContainer.innerHTML = `<h4 class="font-semibold mb-2">현재 등록된 계획 (${date.substring(5)})</h4>`;
                if (itemsForThisDate.length === 0) {
                    listContainer.innerHTML += '<p class="text-sm text-gray-500">계획이 없습니다.</p>';
                } else {
                    itemsForThisDate.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                        itemDiv.innerHTML = `
                            <span class="font-semibold text-sm">${escapeHTML(item.name)}</span>
                            <div class="flex gap-2">
                                <button class="edit-plan-btn text-blue-500"><i class="fas fa-edit"></i></button>
                                <button class="delete-plan-btn text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        itemDiv.querySelector('.edit-plan-btn').onclick = () => renderPlanForm(machine, item, date);
                        itemDiv.querySelector('.delete-plan-btn').onclick = () => openDeletePlanConfirmModal(machine, item.id);
                        listContainer.appendChild(itemDiv);
                    });
                }
                
                renderPlanForm(machine, null, date);
            }
            
            function renderPlanForm(machine, item = null, defaultDate = null) {
                const isEditing = item !== null;
                const formContainer = document.getElementById('plan-form-container');
                formContainer.innerHTML = `
                    <h3 class="text-xl font-bold">${isEditing ? '계획 수정' : '새 계획 추가'}</h3>
                    <div>
                        <label for="plan-item-name" class="text-sm font-medium">품명</label>
                        <input type="text" id="plan-item-name" placeholder="품명 입력" class="mt-1 w-full px-3 py-2 border rounded-lg" value="${isEditing ? escapeHTML(item.name) : ''}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="plan-start-date" class="text-sm font-medium">시작일</label>
                            <input type="date" id="plan-start-date" value="${isEditing ? item.startDate : defaultDate}" class="mt-1 w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="plan-end-date" class="text-sm font-medium">종료일</label>
                            <input type="date" id="plan-end-date" value="${isEditing ? item.endDate : defaultDate}" class="mt-1 w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="flex gap-2">
                        ${isEditing ? `<button id="new-plan-btn" class="w-1/3 bg-gray-500 text-white px-3 py-2 rounded-lg hover:bg-gray-600 text-sm">추가</button>` : ''}
                        <button id="save-plan-item-btn" class="w-full bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 text-sm">${isEditing ? '저장' : '추가'}</button>
                    </div>
                `;
                
                if (isEditing) {
                    document.getElementById('new-plan-btn').onclick = () => renderPlanForm(machine, null, defaultDate);
                }
                document.getElementById('save-plan-item-btn').onclick = () => handleSavePlanItem(machine, item ? item.id : null);
            }

            async function handleSavePlanItem(machine, itemId) {
                const name = document.getElementById('plan-item-name').value.trim();
                const startDate = document.getElementById('plan-start-date').value;
                const endDate = document.getElementById('plan-end-date').value;

                if (!name || !startDate || !endDate) {
                    alert('모든 필드를 입력해주세요.'); return;
                }
                if (parseYYYYMMDD(startDate) > parseYYYYMMDD(endDate)) {
                    alert('시작일은 종료일보다 늦을 수 없습니다.'); return;
                }

                const weekId = get7DaysInfo(currentDayOffset).id;
                const docRef = doc(workPlanCollectionRef, weekId);
                const docSnap = await getDoc(docRef);
                const planData = docSnap.exists() ? docSnap.data() : {};
                const items = planData[machine] || [];

                if (itemId) { // 수정
                    const itemIndex = items.findIndex(item => item.id === itemId);
                    if (itemIndex > -1) {
                        items[itemIndex] = { ...items[itemIndex], name, startDate, endDate };
                    }
                    await updateDoc(docRef, { [machine]: items });
                } else { // 추가
                    const newItem = { id: crypto.randomUUID(), name, startDate, endDate };
                    await setDoc(docRef, { [machine]: arrayUnion(newItem) }, { merge: true });
                }
                closeModal();
            }

            function openDeletePlanConfirmModal(machine, itemId) {
                const modalHTML = `
                    <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">계획을 삭제하시겠습니까?</h3>
                            <p class="text-gray-600 mb-6">이 작업은 되돌릴 수 없습니다.</p>
                            <div class="flex justify-center space-x-4">
                                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button>
                                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg">삭제</button>
                            </div>
                        </div>
                    </div>`;
                showModal(modalHTML);
                document.getElementById('confirm-delete-btn').onclick = () => handleDeletePlanItem(machine, itemId);
                document.getElementById('cancel-delete-btn').onclick = closeModal;
            }

            async function handleDeletePlanItem(machine, itemId) {
                const weekId = get7DaysInfo(currentDayOffset).id;
                const docRef = doc(workPlanCollectionRef, weekId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const planData = docSnap.data();
                    const items = planData[machine] || [];
                    const updatedItems = items.filter(item => item.id !== itemId);
                    await updateDoc(docRef, { [machine]: updatedItems });
                }
                closeModal();
            }

            function openUserDeleteConfirmModal(userId, userName) {
                const modalHTML = `
                    <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm text-center">
                            <i class="fas fa-user-times text-4xl text-red-500 mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">사용자를 삭제하시겠습니까?</h3>
                            <p class="text-gray-600 mb-6">'${escapeHTML(userName)}' 사용자를 삭제합니다.</p>
                            <div class="flex justify-center space-x-4">
                                <button id="cancel-user-delete-btn" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button>
                                <button id="confirm-user-delete-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg">삭제</button>
                            </div>
                        </div>
                    </div>`;
                showModal(modalHTML);
                document.getElementById('confirm-user-delete-btn').onclick = () => deleteUser(userId);
                document.getElementById('cancel-user-delete-btn').onclick = closeModal;
            }
            
            function openEditTaskModal(task) {
                const modalHTML = `
                    <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-30">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md">
                            <h3 class="text-xl font-bold mb-6">일정 수정</h3>
                            <form id="edit-task-form-dynamic">
                                <input type="hidden" id="edit-task-id" value="${task.id}">
                                <div class="mb-4">
                                    <label for="edit-task-content" class="block text-sm font-medium text-gray-700 mb-1">작업 내용</label>
                                    <input type="text" id="edit-task-content" class="w-full px-4 py-2 border rounded-lg" value="${escapeHTML(task.content)}" required>
                                </div>
                                <div class="mb-4">
                                    <label for="edit-task-category" class="block text-sm font-medium text-gray-700 mb-1">구분</label>
                                    <select id="edit-task-category" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="입고" ${task.category === '입고' ? 'selected' : ''}>입고</option>
                                        <option value="출고" ${task.category === '출고' ? 'selected' : ''}>출고</option>
                                        <option value="개발" ${task.category === '개발' ? 'selected' : ''}>개발</option>
                                        <option value="기타" ${task.category === '기타' ? 'selected' : ''}>기타</option>
                                    </select>
                                </div>
                                <div class="mb-6">
                                    <label for="edit-task-due-date" class="block text-sm font-medium text-gray-700 mb-1">마감일</label>
                                    <input type="date" id="edit-task-due-date" class="w-full px-4 py-2 border rounded-lg" value="${task.dueDate}" required>
                                </div>
                                <div class="flex justify-end space-x-4">
                                    <button type="button" id="cancel-edit-btn" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button>
                                    <button type="submit" class="px-6 py-2 bg-teal-600 text-white font-bold rounded-lg">저장</button>
                                </div>
                            </form>
                        </div>
                    </div>`;
                showModal(modalHTML);
                
                document.getElementById('edit-task-form-dynamic').addEventListener('submit', handleUpdateTask);
                document.getElementById('cancel-edit-btn').addEventListener('click', closeModal);
            }

            async function handleUpdateTask(e) {
                e.preventDefault();
                const id = document.getElementById('edit-task-id').value;
                const content = document.getElementById('edit-task-content').value.trim();
                const category = document.getElementById('edit-task-category').value;
                const dueDate = document.getElementById('edit-task-due-date').value;

                if (id && content && dueDate) {
                    const taskDocRef = doc(db, `artifacts/${appId}/public/data/schedules`, id);
                    await updateDoc(taskDocRef, { content, category, dueDate });
                    closeModal();
                }
            }

            function openDeleteConfirmModal(taskId) {
                const modalHTML = `
                    <div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">일정을 삭제하시겠습니까?</h3>
                            <p class="text-gray-600 mb-6">이 작업은 되돌릴 수 없습니다.</p>
                            <div class="flex justify-center space-x-4">
                                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 rounded-lg">취소</button>
                                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg">삭제</button>
                            </div>
                        </div>
                    </div>`;
                showModal(modalHTML);
                document.getElementById('confirm-delete-btn').onclick = () => deleteTask(taskId);
                document.getElementById('cancel-delete-btn').onclick = closeModal;
            }

            async function deleteTask(taskId) {
                const taskDocRef = doc(db, `artifacts/${appId}/public/data/schedules`, taskId);
                await deleteDoc(taskDocRef);
                closeModal();
            }

            function listenForGoals() {
                unsubscribeGoals();
                unsubscribeGoals = onSnapshot(goalsDocRef, (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : { weekly: [], monthly: [] };
                    renderGoals('weekly', data.weekly || []);
                    renderGoals('monthly', data.monthly || []);
                });
            }

            function renderGoals(type, goals) {
                const container = document.getElementById(`${type}-goals-list`);
                container.innerHTML = '';
                let goalsToRender = goals;
                if (goals.length < 5) {
                    goalsToRender = [...goals, ...Array(5 - goals.length).fill({ id: crypto.randomUUID(), text: '', checked: false })];
                }
                
                goalsToRender.forEach(goal => {
                    const goalEl = document.createElement('div');
                    goalEl.className = 'flex items-center gap-2';
                    goalEl.innerHTML = `
                        <input type="checkbox" id="${goal.id}" class="goal-input h-5 w-5 text-teal-600 border-gray-300 rounded focus:ring-teal-500" ${goal.checked ? 'checked' : ''}>
                        <input type="text" value="${escapeHTML(goal.text)}" data-id="${goal.id}" class="w-full border-b focus:border-teal-500 outline-none">
                    `;
                    container.appendChild(goalEl);
                });

                container.querySelectorAll('input').forEach(input => {
                    input.onchange = () => saveGoals();
                    input.onblur = () => saveGoals();
                });
            }

            function addGoal(type) {
                const listId = `${type}-goals-list`;
                const container = document.getElementById(listId);
                const newGoalEl = document.createElement('div');
                newGoalEl.className = 'flex items-center gap-2';
                newGoalEl.innerHTML = `
                    <input type="checkbox" id="${crypto.randomUUID()}" class="goal-input h-5 w-5 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                    <input type="text" value="" data-id="${crypto.randomUUID()}" class="w-full border-b focus:border-teal-500 outline-none">
                `;
                container.appendChild(newGoalEl);
                newGoalEl.querySelector('input[type="text"]').focus();
                newGoalEl.querySelectorAll('input').forEach(input => {
                    input.onchange = () => saveGoals();
                    input.onblur = () => saveGoals();
                });
            }

            async function saveGoals() {
                const weeklyGoals = [];
                document.querySelectorAll('#weekly-goals-list .flex').forEach(el => {
                    const checkbox = el.querySelector('input[type="checkbox"]');
                    const textInput = el.querySelector('input[type="text"]');
                    if (textInput.value.trim() !== '') {
                        weeklyGoals.push({
                            id: checkbox.id,
                            text: textInput.value,
                            checked: checkbox.checked
                        });
                    }
                });

                const monthlyGoals = [];
                document.querySelectorAll('#monthly-goals-list .flex').forEach(el => {
                    const checkbox = el.querySelector('input[type="checkbox"]');
                    const textInput = el.querySelector('input[type="text"]');
                     if (textInput.value.trim() !== '') {
                        monthlyGoals.push({
                            id: checkbox.id,
                            text: textInput.value,
                            checked: checkbox.checked
                        });
                    }
                });

                await setDoc(goalsDocRef, { weekly: weeklyGoals, monthly: monthlyGoals });
            }
            
            // PWA 서비스 워커 등록
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(registration => {
                        console.log('SW registered: ', registration);
                    }).catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
                });
            }

            // 앱 시작
            initializeFirebase();
        });
    </script>
</body>
</html>
